<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.springboot.dao.IMusicDAO">

    <resultMap id="MusicMap" type="com.project.springboot.dto.MusicDTO">
        <id property="m_no" column="m_no" />
        <result property="m_title" column="m_title" />
        <result property="a_no" column="a_no" />
        <result property="b_no" column="b_no" />
        <result property="a_name" column="a_name" />
        <result property="a_image" column="a_image" /> 
        <result property="a_spotify_id" column="a_spotify_id" /> 
        <result property="a_genres" column="a_genres" />
        <result property="isrc_code" column="isrc_code" />
        <result property="m_youtube_id" column="m_youtube_id" />
        <result property="m_preview_url" column="m_preview_url" />
        <result property="b_title" column="b_title" />
        <result property="b_image" column="b_image" />
        <result property="isLiked" column="isLiked" />
    </resultMap>

    <resultMap id="ArtistMap" type="com.project.springboot.dto.ArtistDTO">
        <id property="a_no" column="a_no" />
        <result property="a_name" column="a_name" />
        <result property="a_image" column="a_image" />
        <result property="a_genres" column="a_genres" />
    </resultMap>

	<resultMap id="AlbumMap" type="com.project.springboot.dto.AlbumDTO">
	    <id property="b_no" column="b_no" />
	    <result property="a_no" column="a_no" />
	    <result property="b_title" column="b_title" />
	    <result property="b_date" column="b_date" />
	    <result property="b_image" column="b_image" />
	    <result property="b_type" column="b_type" />
	    <result property="b_description" column="b_description" />
	</resultMap>

    <insert id="insertArtist" parameterType="com.project.springboot.dto.ArtistDTO">
        <selectKey keyProperty="a_no" resultType="int" order="BEFORE">
            SELECT COALESCE(
                (SELECT a_no FROM artists WHERE a_name = #{a_name} AND ROWNUM = 1),
                artist_no_seq.NEXTVAL
            ) FROM DUAL
        </selectKey>
        MERGE INTO artists a
        USING DUAL ON (a.a_name = #{a_name})
        WHEN MATCHED THEN
            UPDATE SET a.a_image = NVL(a.a_image, #{a_image}) 
        WHEN NOT MATCHED THEN
            INSERT (a_no, a_name, a_image)
            VALUES (#{a_no}, #{a_name}, #{a_image})
    </insert>

    <insert id="insertAlbum" parameterType="com.project.springboot.dto.AlbumDTO">
        <selectKey keyProperty="b_no" resultType="int" order="BEFORE">
            SELECT COALESCE(
                (SELECT b_no FROM album WHERE b_title = #{b_title} AND a_no = #{a_no} AND ROWNUM = 1),
                album_no_seq.NEXTVAL
            ) FROM DUAL
        </selectKey>
        MERGE INTO album b
        USING DUAL ON (b.b_title = #{b_title} AND b.a_no = #{a_no})
        WHEN NOT MATCHED THEN
            INSERT (b_no, a_no, b_title, b_image)
            VALUES (#{b_no}, #{a_no}, #{b_title}, #{b_image})
    </insert>
    
    <insert id="insertMusic" parameterType="com.project.springboot.dto.MusicDTO">
        <selectKey keyProperty="m_no" resultType="int" order="BEFORE">
            SELECT COALESCE(
                (SELECT m_no FROM music WHERE isrc_code = #{isrc_code} AND ROWNUM = 1),
                music_no_seq.NEXTVAL
            ) FROM DUAL
        </selectKey>
        MERGE INTO music m
        USING DUAL ON (m.isrc_code = #{isrc_code})
        WHEN NOT MATCHED THEN
            INSERT (m_no, m_title, a_no, b_no, isrc_code, m_youtube_id, m_preview_url)
            VALUES (#{m_no}, #{m_title}, #{a_no}, #{b_no}, #{isrc_code}, #{m_youtube_id}, #{m_preview_url})
    </insert>

    <update id="updateYoutubeId">
        UPDATE music SET m_youtube_id = #{m_youtube_id} WHERE m_no = #{m_no}
    </update>

    <update id="updateMusicPreview">
        UPDATE music SET m_preview_url = #{m_preview_url} WHERE m_no = #{m_no}
    </update>
    
    <update id="updateAlbumImage">
        UPDATE album SET b_image = #{b_image} 
        WHERE b_no = (SELECT b_no FROM music WHERE m_no = #{m_no})
    </update>
    <update id="updateMusicIsrc">
    UPDATE music 
    SET isrc_code = #{isrc_code} 
    WHERE m_no = #{m_no}
</update>
    <update id="updateArtistGenre">
        UPDATE artists SET a_genres = #{a_genres} 
        WHERE a_no = (SELECT a_no FROM music WHERE m_no = #{m_no})
    </update>

    <update id="updateArtistImage">
        UPDATE artists SET a_image = #{a_image} WHERE a_no = #{a_no}
    </update>

    <select id="selectMusicByKeyword" resultMap="MusicMap">
        SELECT m.m_no, m.m_title, m.a_no, m.b_no, m.isrc_code, m.m_youtube_id, m.m_preview_url,
               a.a_name, b.b_title, b.b_image,
               (SELECT CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END FROM likes l 
                WHERE l.l_target_type = 'MUSIC' AND l.l_target_no = m.m_no AND l.u_no = #{u_no}) as isLiked
        FROM music m
        LEFT JOIN artists a ON m.a_no = a.a_no
        LEFT JOIN album b ON m.b_no = b.b_no
        WHERE (UPPER(m.m_title) LIKE UPPER('%' || #{keyword} || '%') OR UPPER(a.a_name) LIKE UPPER('%' || #{keyword} || '%') OR UPPER(b.b_title) LIKE UPPER('%' || #{keyword} || '%'))
    </select>

    <select id="selectMusicByTitle" resultMap="MusicMap">
        SELECT m.m_no, m.m_title, m.a_no, m.b_no, m.isrc_code, m.m_youtube_id, m.m_preview_url,
               a.a_name, b.b_title, b.b_image,
               (SELECT CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END FROM likes l 
                WHERE l.l_target_type = 'MUSIC' AND l.l_target_no = m.m_no AND l.u_no = #{u_no}) as isLiked
        FROM music m
        LEFT JOIN artists a ON m.a_no = a.a_no
        LEFT JOIN album b ON m.b_no = b.b_no
        WHERE UPPER(m.m_title) LIKE UPPER('%' || #{keyword} || '%')
        ORDER BY m.m_no DESC
    </select>

    <select id="selectMusicByArtist" resultMap="MusicMap">
        SELECT m.m_no, m.m_title, m.a_no, m.b_no, m.isrc_code, m.m_youtube_id, m.m_preview_url,
               a.a_name, b.b_title, b.b_image,
               (SELECT CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END FROM likes l 
                WHERE l.l_target_type = 'MUSIC' AND l.l_target_no = m.m_no AND l.u_no = #{u_no}) as isLiked
        FROM music m
        LEFT JOIN artists a ON m.a_no = a.a_no
        LEFT JOIN album b ON m.b_no = b.b_no
        WHERE UPPER(a.a_name) LIKE UPPER('%' || #{keyword} || '%')
        ORDER BY m.m_no DESC
    </select>

    <select id="selectArtistByNo" resultMap="ArtistMap">
        SELECT a.a_no, a.a_name,
               NVL(a.a_image, (SELECT b_image FROM (SELECT b_image FROM album WHERE a_no = a.a_no AND b_image IS NOT NULL ORDER BY b_no DESC) WHERE ROWNUM = 1)) AS a_image,
               a.a_genres
        FROM artists a WHERE a.a_no = #{a_no}
    </select>
    
    <select id="selectMusicByArtistNo" resultMap="MusicMap">
        SELECT m.*, a.a_name, b.b_title, b.b_image,
               (SELECT CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END FROM likes l 
                WHERE l.l_target_type = 'MUSIC' AND l.l_target_no = m.m_no AND l.u_no = #{u_no}) as isLiked
        FROM music m
        JOIN artists a ON m.a_no = a.a_no
        JOIN album b ON m.b_no = b.b_no
        WHERE m.a_no = #{a_no}
        ORDER BY b.b_title ASC, m.m_title ASC
    </select>
    
    <select id="selectAlbumByNo" resultMap="AlbumMap">
	    SELECT 
	        B_NO, 
	        A_NO, 
	        B_TITLE, 
	        B_DATE, 
	        B_IMAGE, 
	        B_TYPE, 
	        B_DESCRIPTION 
	    FROM ALBUM 
	    WHERE B_NO = #{b_no}
	</select>

	<select id="selectMusicByAlbumNo" resultMap="MusicMap">
	    SELECT m.*, a.a_name, b.b_title, b.b_image,
	           (SELECT CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END FROM likes l 
	            WHERE l.l_target_type = 'MUSIC' AND l.l_target_no = m.m_no AND l.u_no = #{u_no}) as isLiked
	    FROM music m
	    LEFT JOIN artists a ON m.a_no = a.a_no  LEFT JOIN album b ON m.b_no = b.b_no    WHERE m.b_no = #{b_no}
	    ORDER BY m.m_no ASC
	</select>

    <select id="selectTop100Music" resultType="map">
        SELECT * FROM (
            SELECT 
                m.m_no          AS "MNO",
                m.a_no          AS "ANO",
                m.b_no          AS "BNO",
                m.m_title       AS "TITLE", 
                a.a_name        AS "ARTIST",
                b.b_image       AS "ALBUM_IMG",
                m.m_youtube_id  AS "YOUTUBE_ID",
                m.m_preview_url AS "PREVIEW_URL",
                COUNT(h.h_no)   AS "CNT",
                (SELECT COUNT(*) FROM likes l WHERE l.l_target_type = 'MUSIC' AND l.l_target_no = m.m_no AND l.u_no = #{u_no}) AS "MY_LIKE"
            FROM history h
            JOIN music m ON h.m_no = m.m_no
            JOIN artists a ON m.a_no = a.a_no
            LEFT JOIN album b ON m.b_no = b.b_no
            WHERE h.h_played_at >= SYSDATE - 1 
            GROUP BY m.m_no, m.a_no, m.b_no, m.m_title, a.a_name, b.b_image, m.m_youtube_id, m.m_preview_url
            ORDER BY "CNT" DESC, m.m_title ASC
        ) WHERE ROWNUM &lt;= 100
    </select>
    
    <select id="selectWeeklyMusic" resultType="map">
        SELECT * FROM (
            SELECT 
                m.m_no          AS "MNO",
                m.a_no          AS "ANO",
                m.b_no          AS "BNO",
                m.m_title       AS "TITLE", 
                a.a_name        AS "ARTIST",
                b.b_image       AS "ALBUM_IMG",
                m.m_youtube_id  AS "YOUTUBE_ID",
                m.m_preview_url AS "PREVIEW_URL",
                COUNT(h.h_no)   AS "CNT",
                (SELECT COUNT(*) FROM likes l WHERE l.l_target_type = 'MUSIC' AND l.l_target_no = m.m_no AND l.u_no = #{u_no}) AS "MY_LIKE"
            FROM history h
            JOIN music m ON h.m_no = m.m_no
            JOIN artists a ON m.a_no = a.a_no
            LEFT JOIN album b ON m.b_no = b.b_no
            WHERE h.h_played_at >= SYSDATE - 7 
            GROUP BY m.m_no, m.a_no, m.b_no, m.m_title, a.a_name, b.b_image, m.m_youtube_id, m.m_preview_url
            ORDER BY "CNT" DESC, m.m_title ASC
        ) WHERE ROWNUM &lt;= 100
    </select>

    <select id="selectMonthlyMusic" resultType="map">
        SELECT * FROM (
            SELECT 
                m.m_no          AS "MNO",
                m.a_no          AS "ANO",
                m.b_no          AS "BNO",
                m.m_title       AS "TITLE", 
                a.a_name        AS "ARTIST",
                b.b_image       AS "ALBUM_IMG",
                m.m_youtube_id  AS "YOUTUBE_ID",
                m.m_preview_url AS "PREVIEW_URL",
                COUNT(h.h_no)   AS "CNT",
                (SELECT COUNT(*) FROM likes l WHERE l.l_target_type = 'MUSIC' AND l.l_target_no = m.m_no AND l.u_no = #{u_no}) AS "MY_LIKE"
            FROM history h
            JOIN music m ON h.m_no = m.m_no
            JOIN artists a ON m.a_no = a.a_no
            LEFT JOIN album b ON m.b_no = b.b_no
            WHERE h.h_played_at >= TRUNC(SYSDATE, 'MM') 
            GROUP BY m.m_no, m.a_no, m.b_no, m.m_title, a.a_name, b.b_image, m.m_youtube_id, m.m_preview_url
            ORDER BY "CNT" DESC, m.m_title ASC
        ) WHERE ROWNUM &lt;= 100
    </select>

    <select id="selectYearlyMusic" resultType="map">
        SELECT * FROM (
            SELECT 
                m.m_no          AS "MNO",
                m.a_no          AS "ANO",
                m.b_no          AS "BNO",
                m.m_title       AS "TITLE", 
                a.a_name        AS "ARTIST",
                b.b_image       AS "ALBUM_IMG",
                m.m_youtube_id  AS "YOUTUBE_ID",
                m.m_preview_url AS "PREVIEW_URL",
                COUNT(h.h_no)   AS "CNT",
                (SELECT COUNT(*) FROM likes l WHERE l.l_target_type = 'MUSIC' AND l.l_target_no = m.m_no AND l.u_no = #{u_no}) AS "MY_LIKE"
            FROM history h
            JOIN music m ON h.m_no = m.m_no
            JOIN artists a ON m.a_no = a.a_no
            LEFT JOIN album b ON m.b_no = b.b_no
            WHERE h.h_played_at >= TRUNC(SYSDATE, 'YYYY') 
            GROUP BY m.m_no, m.a_no, m.b_no, m.m_title, a.a_name, b.b_image, m.m_youtube_id, m.m_preview_url
            ORDER BY "CNT" DESC, m.m_title ASC
        ) WHERE ROWNUM &lt;= 100
    </select>

    <select id="selectRegionalMusic" resultType="map">
	    SELECT * FROM (
	        SELECT 
	            m.m_no AS "MNO", 
	            m.a_no AS "ANO",
	            m.b_no AS "BNO",
	            m.m_title AS "TITLE", 
	            art.a_name AS "ARTIST", 
	            alb.b_image AS "ALBUM_IMG", 
	            m.m_youtube_id AS "YOUTUBE_ID",
	            m.m_preview_url AS "PREVIEW_URL",
	            COUNT(h.h_no) AS "CNT",
	            (SELECT COUNT(*) FROM LIKES l WHERE l.u_no = #{u_no} AND l.l_target_no = m.m_no) AS "MY_LIKE"
	        FROM history h
	        JOIN music m ON h.m_no = m.m_no
	        JOIN album alb ON m.b_no = alb.b_no
	        JOIN artists art ON m.a_no = art.a_no
	        <where>
	            <choose>
	                <when test="city == 'SEOUL'">
	                    AND h.h_lat BETWEEN 37.0 AND 38.5 
	                    AND h.h_lon BETWEEN 126.3 AND 127.8
	                </when>
	                <when test="city == 'BUSAN'">
	                    AND h.h_lat BETWEEN 34.8 AND 35.5 
	                    AND h.h_lon BETWEEN 128.5 AND 129.5
	                </when>
	                <when test="city == 'DAEGU'">
	                    AND h.h_lat BETWEEN 35.5 AND 36.3 
	                    AND h.h_lon BETWEEN 128.2 AND 129.0
	                </when>
	                <when test="city == 'DAEJEON'">
	                    AND h.h_lat BETWEEN 36.0 AND 36.8 
	                    AND h.h_lon BETWEEN 127.0 AND 127.8
	                </when>
	                <when test="city == 'JEJU'">
	                    AND h.h_lat BETWEEN 33.0 AND 33.7 
	                    AND h.h_lon BETWEEN 126.0 AND 127.2
	                </when>
	                <otherwise>
	                    AND h.h_location = #{city}
	                </otherwise>
	            </choose>
	        </where>
	        GROUP BY m.m_no, m.a_no, m.b_no, m.m_title, art.a_name, alb.b_image, m.m_youtube_id, m.m_preview_url
	        ORDER BY "CNT" DESC
	    ) WHERE ROWNUM &lt;= 100
	</select>

    <select id="checkLike" resultType="int">
        SELECT COUNT(*) FROM likes WHERE u_no = #{u_no} AND l_target_type = 'MUSIC' AND l_target_no = #{m_no}
    </select>
    
    <insert id="insertLike">
        INSERT INTO likes (l_no, u_no, l_target_type, l_target_no) 
        VALUES (likes_seq.NEXTVAL, #{u_no}, 'MUSIC', #{m_no})
    </insert>
    
    <delete id="deleteLike">
        DELETE FROM likes WHERE u_no = #{u_no} AND l_target_type = 'MUSIC' AND l_target_no = #{m_no}
    </delete>

    <insert id="insertLibraryTrack">
        MERGE INTO playlists p
        USING DUAL ON (p.u_no = #{u_no} AND p.m_no = #{m_no} AND p.t_title = 'MY_LIBRARY')
        WHEN NOT MATCHED THEN
            INSERT (t_no, u_no, m_no, t_title, t_private, t_saved)
            VALUES (playlists_seq.NEXTVAL, #{u_no}, #{m_no}, 'MY_LIBRARY', 'Y', TO_CHAR(SYSDATE, 'YYYY-MM-DD'))
    </insert>

    <select id="selectMusicByLibrary" resultMap="MusicMap">
	    SELECT m.m_no, m.m_title, m.a_no, m.b_no, a.a_name, b.b_image, m.m_youtube_id, m.m_preview_url,
	           (SELECT CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END FROM likes l 
	            WHERE l.l_target_type = 'MUSIC' AND l.l_target_no = m.m_no AND l.u_no = #{u_no}) as isLiked
	    FROM playlists p
	    JOIN music m ON p.m_no = m.m_no
	    JOIN artists a ON m.a_no = a.a_no
	    LEFT JOIN album b ON m.b_no = b.b_no
	    WHERE p.u_no = #{u_no} AND p.t_title = 'MY_LIBRARY' 
	    ORDER BY p.t_no DESC
	</select>
	
	<select id="selectLikedMusic" resultMap="MusicMap">
	    SELECT m.m_no, m.m_title, m.a_no, m.b_no, a.a_name, b.b_image, m.m_youtube_id, m.m_preview_url,
	           'Y' as isLiked
	    FROM likes l
	    JOIN music m ON l.l_target_no = m.m_no
	    JOIN artists a ON m.a_no = a.a_no
	    LEFT JOIN album b ON m.b_no = b.b_no
	    WHERE l.u_no = #{u_no} AND l.l_target_type = 'MUSIC'
	    ORDER BY l.l_no DESC
	</select>
    
    <delete id="deleteLibraryTrack">
        DELETE FROM playlists WHERE u_no = #{u_no} AND m_no = #{m_no} AND t_title = 'MY_LIBRARY'
    </delete>

    <insert id="insertHistory">
        INSERT INTO history (h_no, u_no, m_no, h_location, h_weather, h_lat, h_lon, h_played_at) 
        VALUES (history_no_seq.NEXTVAL, #{u_no}, #{m_no}, #{h_location}, #{h_weather}, #{h_lat}, #{h_lon}, SYSDATE)
    </insert>

    <select id="selectMusicByLyrics" resultMap="MusicMap">
      SELECT m.m_no, m.m_title, m.a_no, m.b_no, m.isrc_code, m.m_youtube_id, m.m_preview_url, a.a_name, b.b_title, b.b_image
      FROM music m
      LEFT JOIN artists a ON m.a_no = a.a_no
      LEFT JOIN album b ON m.b_no = b.b_no
      JOIN music_lyrics l ON m.m_no = l.m_no
      WHERE DBMS_LOB.INSTR(UPPER(l.lyrics_text), UPPER(#{keyword})) > 0
      ORDER BY m.m_no DESC
    </select>

<select id="selectMNoByTitleAndArtist" resultType="Integer">
    SELECT m_no FROM (
        SELECT m.m_no 
        FROM music m 
        JOIN artists a ON m.a_no = a.a_no
        WHERE 
            REPLACE(UPPER(m.m_title), ' ', '') = REPLACE(UPPER(#{title}), ' ', '')
            AND 
            (
                REPLACE(UPPER(a.a_name), ' ', '') = REPLACE(UPPER(#{artist}), ' ', '')
                OR REPLACE(UPPER(a.a_name), ' ', '') LIKE '%' || REPLACE(UPPER(#{artist}), ' ', '') || '%'
                OR REPLACE(UPPER(#{artist}), ' ', '') LIKE '%' || REPLACE(UPPER(a.a_name), ' ', '') || '%'
            )
        ORDER BY m.m_no DESC
    ) WHERE ROWNUM = 1
</select>

    <insert id="insertLyrics" parameterType="map">
        MERGE INTO music_lyrics l
        USING DUAL ON (l.m_no = #{m_no})
        WHEN NOT MATCHED THEN
            INSERT (m_no, lyrics_text, lyricist) VALUES (#{m_no}, #{lyrics_text}, #{lyricist})
        WHEN MATCHED THEN
            UPDATE SET lyrics_text = #{lyrics_text}, lyricist = #{lyricist}
    </insert>

    <select id="selectLyrics" resultType="map">
        SELECT m_no, lyrics_text, lyrics_trans, lyricist, lyrics_sync FROM music_lyrics WHERE m_no = #{m_no}
    </select>

    <insert id="insertMusicFeature" parameterType="map">
        MERGE INTO music_feature f
        USING DUAL ON (f.music_id = #{m_no})
        WHEN NOT MATCHED THEN
            INSERT (music_id, danceability, energy, valence, acousticness, instrumentalness, liveness, speechiness, tempo)
            VALUES (#{m_no}, #{danceability}, #{energy}, #{valence}, #{acousticness}, #{instrumentalness}, #{liveness}, #{speechiness}, #{tempo})
        WHEN MATCHED THEN
            UPDATE SET danceability = #{danceability}, energy = #{energy}, valence = #{valence}, tempo = #{tempo}
    </insert>

    <insert id="insertTag" parameterType="map">
        <selectKey keyProperty="g_no" resultType="int" order="BEFORE">
            SELECT COALESCE((SELECT g_no FROM tags WHERE g_name = #{g_name} AND ROWNUM = 1), tags_no_seq.NEXTVAL) FROM DUAL
        </selectKey>
        MERGE INTO tags t
        USING DUAL ON (t.g_name = #{g_name})
        WHEN NOT MATCHED THEN
            INSERT (g_no, g_name, g_type) VALUES (#{g_no}, #{g_name}, #{g_type})
    </insert>

    <insert id="insertMusicTagMap">
        MERGE INTO music_tag_map m
        USING DUAL ON (m.m_no = #{m_no} AND m.g_no = #{g_no})
        WHEN NOT MATCHED THEN
            INSERT (mapping_no, m_no, g_no) VALUES (mapping_no_seq.NEXTVAL, #{m_no}, #{g_no})
    </insert>

<select id="selectMusicByNo" resultMap="MusicMap">
    SELECT 
        m.m_no, 
        m.m_title, 
        m.a_no, 
        m.b_no, 
        m.isrc_code, 
        m.m_youtube_id, 
        m.m_preview_url, 
        a.a_name, 
        a.a_spotify_id,  a.a_genres,      b.b_title,
        b.b_image        FROM music m
    JOIN artists a ON m.a_no = a.a_no
    JOIN album b ON m.b_no = b.b_no
    WHERE m.m_no = #{m_no}
</select>

    <select id="selectMusicFeature" resultType="map">
        SELECT music_id as "m_no", danceability, energy, valence, acousticness, instrumentalness, liveness, speechiness, tempo
        FROM music_feature WHERE music_id = #{m_no}
    </select>
    
<select id="selectMusicByMNoList" resultMap="MusicMap">
    SELECT 
        m.m_no, 
        m.m_title, 
        m.a_no, 
        m.b_no, 
        a.a_name, 
        b.b_title, 
        b.b_image,  
        m.m_preview_url,
        (SELECT CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END 
         FROM likes l 
         WHERE l.l_target_type = 'MUSIC' 
           AND l.l_target_no = m.m_no 
           AND l.u_no = #{uNo}) as isLiked
    FROM music m
    JOIN artists a ON m.a_no = a.a_no
    JOIN album b ON m.b_no = b.b_no  
    WHERE m.m_no IN 
    <foreach item="id" collection="mNoList" open="(" separator="," close=")">
        #{id}
    </foreach>
    ORDER BY DECODE(m.m_no, 
    <foreach item="id" collection="mNoList" index="index" separator=", ">
        #{id}, #{index}
    </foreach>
    )
</select>
<update id="updateArtistSpotifyId">
    UPDATE artists 
    SET a_spotify_id = #{spotifyId} 
    WHERE a_no = #{aNo}
</update>

<update id="updateArtistGenres">
    UPDATE artists 
    SET a_genres = #{genres} 
    WHERE a_no = #{aNo}
</update>
<update id="updateArtistDetails" parameterType="com.project.springboot.dto.ArtistDTO">
    UPDATE artists
    SET 
        a_genres = #{a_genres},
        a_followers = #{a_followers},
        a_image = #{a_image}
    WHERE a_no = #{a_no}
</update>
<select id="selectANoByArtistName" resultType="Integer">
    SELECT a_no 
    FROM artists 
    WHERE a_name = #{a_name}
</select>

<select id="selectBNoByTitleAndANo" resultType="Integer">
    SELECT b_no 
    FROM album 
    WHERE b_title = #{b_title} 
      AND a_no = #{a_no}
</select>
<select id="selectMNoWithOriginal" resultType="Integer">
    SELECT m_no FROM (
        SELECT m.m_no,
               -- 검색어와 정확히 일치하는 가수를 찾았을 때 가중치를 줌
               CASE 
                 WHEN REPLACE(UPPER(a.a_name), ' ', '') = REPLACE(UPPER(#{artist}), ' ', '') THEN 1
                 WHEN REPLACE(UPPER(a.a_name), ' ', '') = REPLACE(UPPER(#{original}), ' ', '') THEN 2
                 ELSE 3 
               END as priority
        FROM music m 
        JOIN artists a ON m.a_no = a.a_no
        WHERE 
            REPLACE(UPPER(m.m_title), ' ', '') = REPLACE(UPPER(#{title}), ' ', '')
            AND 
            (
                REPLACE(UPPER(a.a_name), ' ', '') = REPLACE(UPPER(#{artist}), ' ', '')
                OR REPLACE(UPPER(a.a_name), ' ', '') = REPLACE(UPPER(#{original}), ' ', '')
            )
        -- 1순위: 이름이 정확히 맞는 것, 2순위: 최신 곡(번호가 큰 것)
        ORDER BY priority ASC, m.m_no DESC
    ) WHERE ROWNUM = 1
</select>
<insert id="insertPlayLog">
    INSERT INTO PLAY_LOG (M_NO, U_NO, PLAY_DATE)
    VALUES (#{mNo}, #{uNo}, SYSDATE)
</insert>

</mapper>