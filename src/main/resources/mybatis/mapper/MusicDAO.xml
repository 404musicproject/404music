<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.springboot.dao.IMusicDAO">

    <resultMap id="MusicMap" type="com.project.springboot.dto.MusicDTO">
        <id property="m_no" column="m_no" />
        <result property="m_title" column="m_title" />
        <result property="a_no" column="a_no" />
        <result property="b_no" column="b_no" />
        <result property="isrc_code" column="isrc_code" />
        <result property="m_youtube_id" column="m_youtube_id" />
        <result property="m_preview_url" column="m_preview_url" />
        <result property="a_name" column="a_name" />
        <result property="b_title" column="b_title" />
    </resultMap>

    <insert id="insertArtist" parameterType="com.project.springboot.dto.ArtistDTO">
        <selectKey keyProperty="a_no" resultType="int" order="BEFORE">
            SELECT COALESCE(
                (SELECT a_no FROM artists WHERE a_name = #{a_name} AND ROWNUM = 1),
                artist_no_seq.NEXTVAL
            ) FROM DUAL
        </selectKey>
        MERGE INTO artists a
        USING DUAL ON (a.a_name = #{a_name})
        WHEN NOT MATCHED THEN
            INSERT (a_no, a_name, a_image)
            VALUES (#{a_no}, #{a_name}, #{a_image})
    </insert>

    <insert id="insertAlbum" parameterType="com.project.springboot.dto.AlbumDTO">
        <selectKey keyProperty="b_no" resultType="int" order="BEFORE">
            SELECT COALESCE(
                (SELECT b_no FROM album WHERE b_title = #{b_title} AND a_no = #{a_no} AND ROWNUM = 1),
                album_no_seq.NEXTVAL
            ) FROM DUAL
        </selectKey>
        MERGE INTO album b
        USING DUAL ON (b.b_title = #{b_title} AND b.a_no = #{a_no})
        WHEN NOT MATCHED THEN
            INSERT (b_no, a_no, b_title, b_image)
            VALUES (#{b_no}, #{a_no}, #{b_title}, #{b_image})
    </insert>
    
    <insert id="insertMusic" parameterType="com.project.springboot.dto.MusicDTO">
        MERGE INTO music m
        USING DUAL ON (m.isrc_code = #{isrc_code})
        WHEN NOT MATCHED THEN
            INSERT (m_no, m_title, a_no, b_no, isrc_code, m_youtube_id, m_preview_url)
            VALUES (music_no_seq.NEXTVAL, #{m_title}, #{a_no}, #{b_no}, #{isrc_code}, #{m_youtube_id}, #{m_preview_url})
    </insert>

    <update id="updateYoutubeId">
        UPDATE music 
        SET m_youtube_id = #{m_youtube_id} 
        WHERE m_no = #{m_no}
    </update>

    <select id="selectMusicByKeyword" resultMap="MusicMap">
        SELECT 
            m.m_no, m.m_title, m.a_no, m.b_no, 
            m.isrc_code, m.m_youtube_id, m.m_preview_url,
            a.a_name, b.b_title
        FROM music m
        LEFT JOIN artists a ON m.a_no = a.a_no
        LEFT JOIN album b ON m.b_no = b.b_no
        WHERE (
            UPPER(m.m_title) LIKE UPPER('%' || #{keyword} || '%')
            OR UPPER(a.a_name) LIKE UPPER('%' || #{keyword} || '%')
            OR UPPER(b.b_title) LIKE UPPER('%' || #{keyword} || '%')
        )
    </select>
    
    <insert id="insertHistory" parameterType="com.project.springboot.dto.HistoryDTO">
        INSERT INTO history (h_no, u_no, m_no, h_location, h_weather, h_played_at)
        VALUES (HISTORY_NO_SEQ.NEXTVAL, #{u_no}, #{m_no}, #{h_location}, #{h_weather}, SYSDATE)
    </insert>

    <select id="selectTop100Music" resultType="map">
	    SELECT * FROM (
	        SELECT 
	            m.m_no          AS "MNO",
	            m.m_title       AS "TITLE", 
	            a.a_name        AS "ARTIST",
	            b.b_image       AS "ALBUM_IMG",
	            m.m_youtube_id  AS "YOUTUBE_ID",
	            m.m_preview_url AS "PREVIEW_URL",
	            COUNT(h.h_no)   AS "CNT",
	            /* 현재 테이블 구조에 맞게 수정: 
	               타입이 'MUSIC'이고, 타겟 번호가 곡 번호(m.m_no)와 일치하는지 확인 
	            */
	            (SELECT COUNT(*) FROM likes l 
	             WHERE l.l_target_type = 'MUSIC' 
	               AND l.l_target_no = m.m_no 
	               AND l.u_no = #{u_no}) AS "MY_LIKE"
	        FROM history h
	        JOIN music m ON h.m_no = m.m_no
	        JOIN artists a ON m.a_no = a.a_no
	        LEFT JOIN album b ON m.b_no = b.b_no
	        WHERE h.h_played_at >= SYSDATE - 1 
	        GROUP BY 
	            m.m_no, 
	            m.m_title, 
	            a.a_name, 
	            b.b_image, 
	            m.m_youtube_id, 
	            m.m_preview_url
	        ORDER BY "CNT" DESC, m.m_title ASC
	    ) WHERE ROWNUM &lt;= 100
	</select>
	
	<select id="checkLike" resultType="int">
	    SELECT COUNT(*) FROM likes 
	    WHERE u_no = #{u_no} 
	      AND l_target_type = 'MUSIC' 
	      AND l_target_no = #{m_no}
	</select>
	
	<insert id="insertLike">
	    INSERT INTO likes (l_no, u_no, l_target_type, l_target_no) 
	    VALUES (likes_seq.NEXTVAL, #{u_no}, 'MUSIC', #{m_no})
	</insert>
	
	<delete id="deleteLike">
	    DELETE FROM likes 
	    WHERE u_no = #{u_no} 
	      AND l_target_type = 'MUSIC' 
	      AND l_target_no = #{m_no}
	</delete>

    <update id="updateMusicPreview">
        UPDATE music SET m_preview_url = #{m_preview_url} WHERE m_no = #{m_no}
    </update>
    
    <update id="updateAlbumImage">
        UPDATE album SET b_image = #{b_image} 
        WHERE b_no = (SELECT b_no FROM music WHERE m_no = #{m_no})
    </update>
    
    <update id="updateArtistGenre">
        UPDATE artists SET a_genres = #{a_genres} 
        WHERE a_no = (SELECT a_no FROM music WHERE m_no = #{m_no})
    </update>

</mapper>