<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.springboot.dao.IPlaylistDAO">

    <!-- =========================
         Playlist
    ========================== -->
    <select id="selectPlaylistsByUser" parameterType="long" resultType="com.project.springboot.dto.PlaylistDTO">
        SELECT
            p.t_no   AS tNo,
            p.u_no   AS uNo,
            p.m_no   AS mNo,
            p.t_title AS tTitle,
            p.t_private AS tPrivate,
            p.t_saved AS tSaved,
            m.m_title AS coverTitle,
            a.a_name  AS coverArtist
        FROM playlists p
        JOIN music m   ON p.m_no = m.m_no
        JOIN artists a ON m.a_no = a.a_no
        WHERE p.u_no = #{uNo}
        ORDER BY p.t_no DESC
    </select>

    <select id="selectPlaylistById" parameterType="long" resultType="com.project.springboot.dto.PlaylistDTO">
        SELECT
            p.t_no   AS tNo,
            p.u_no   AS uNo,
            p.m_no   AS mNo,
            p.t_title AS tTitle,
            p.t_private AS tPrivate,
            p.t_saved AS tSaved,
            m.m_title AS coverTitle,
            a.a_name  AS coverArtist
        FROM playlists p
        JOIN music m   ON p.m_no = m.m_no
        JOIN artists a ON m.a_no = a.a_no
        WHERE p.t_no = #{tNo}
    </select>

    <!-- 기존 SQL 파일의 시퀀스 이름(오타 포함): playists_seq -->
    <insert id="insertPlaylist" parameterType="com.project.springboot.dto.PlaylistDTO">
        <selectKey keyProperty="tNo" order="BEFORE" resultType="long">
            SELECT playists_seq.NEXTVAL FROM dual
        </selectKey>
        INSERT INTO playlists (t_no, u_no, m_no, t_title, t_private, t_saved)
        VALUES (#{tNo}, #{uNo}, #{mNo}, #{tTitle}, #{tPrivate}, #{tSaved})
    </insert>

    <delete id="deletePlaylistTracks" parameterType="long">
        DELETE FROM playlist_tracks WHERE t_no = #{tNo}
    </delete>

    <delete id="deletePlaylist" parameterType="long">
        DELETE FROM playlists WHERE t_no = #{tNo}
    </delete>

    <!-- =========================
         Playlist Tracks
    ========================== -->
    <select id="selectPlaylistTracks" parameterType="long" resultType="com.project.springboot.dto.PlaylistTrackViewDTO">
        SELECT
            pt.pt_no AS ptNo,
            pt.t_no  AS tNo,
            pt.m_no  AS mNo,
            pt.m_order AS mOrder,
            pt.pt_added_at AS ptAddedAt,
            m.m_title AS mTitle,
            a.a_name  AS aName
        FROM playlist_tracks pt
        JOIN music m   ON pt.m_no = m.m_no
        JOIN artists a ON m.a_no = a.a_no
        WHERE pt.t_no = #{tNo}
        ORDER BY NVL(pt.m_order, 999), pt.pt_no
    </select>

    <select id="selectNextOrder" parameterType="long" resultType="int">
        SELECT NVL(MAX(m_order), 0) + 1
        FROM playlist_tracks
        WHERE t_no = #{tNo}
    </select>

    <!-- 기존 SQL 파일의 시퀀스 이름(오타 포함): playist_tracks_seq -->
    <insert id="insertPlaylistTrack">
        INSERT INTO playlist_tracks (pt_no, t_no, m_no, m_order, pt_added_at)
        VALUES (playist_tracks_seq.NEXTVAL, #{tNo}, #{mNo}, #{mOrder}, SYSDATE)
    </insert>

    <delete id="deletePlaylistTrack" parameterType="long">
        DELETE FROM playlist_tracks WHERE pt_no = #{ptNo}
    </delete>

    <!-- =========================
         Library (Likes)
    ========================== -->
    <select id="selectLikedSongs" parameterType="long" resultType="com.project.springboot.dto.LibrarySongDTO">
        SELECT
            l.l_no AS lNo,
            l.u_no AS uNo,
            l.l_target_type AS lTargetType,
            l.l_target_no AS lTargetNo,
            m.m_title AS mTitle,
            a.a_name AS aName
        FROM likes l
        JOIN music m   ON l.l_target_no = m.m_no
        JOIN artists a ON m.a_no = a.a_no
        WHERE l.u_no = #{uNo}
          AND l.l_target_type = 'MUSIC'
        ORDER BY l.l_no DESC
    </select>

    <insert id="insertLikeSong">
        INSERT INTO likes (l_no, u_no, l_target_type, l_target_no)
        VALUES (likes_seq.NEXTVAL, #{uNo}, 'MUSIC', #{mNo})
    </insert>

    <delete id="deleteLikeSong">
        DELETE FROM likes
        WHERE u_no = #{uNo}
          AND l_target_type = 'MUSIC'
          AND l_target_no = #{mNo}
    </delete>

</mapper>